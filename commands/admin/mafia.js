const crypto = require('crypto');

module.exports = {
  players: [],
  gameState: null,
  phase: null,
  nightActions: {},
  votes: {},
  lastVoteTime: null,
  commandCooldowns: {},
  masterid: '100092496586513', // рд╢реИрд▓реЗрдВрджреНрд░ рдХрд╛ ID

  handleEvent(api, event, roleTokens) {
    if (event.type !== 'message' || !event.body) return;

    const threadID = event.threadID;
    const senderID = event.senderID;
    const message = event.body.toLowerCase().trim();
    const senderName = event.senderName || senderID;

    // рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдЗрд╡реЗрдВрдЯреНрд╕ рд╕реНрдХрд┐рдк рдХрд░реЗрдВ
    if (this.commandCooldowns[event.messageID]) {
      console.log('[DEBUG] Skipping duplicate event:', event.messageID);
      return;
    }
    this.commandCooldowns[event.messageID] = true;

    if (message.startsWith('#mafia')) {
      const args = message.split(' ').slice(1);
      const command = args[0] || '';

      if (command === 'start') {
        if (this.gameState) {
          api.sendMessage('рдЧреЗрдо рдкрд╣рд▓реЗ рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИ! #mafia stop рд╕реЗ рдмрдВрдж рдХрд░реЗрдВред', threadID);
          return;
        }
        this.gameState = 'waiting';
        this.players = [];
        api.sendMessage('рдорд╛рдлрд┐рдпрд╛ рдЧреЗрдо рд╢реБрд░реВ! #mafia join рд╕реЗ рдЬреБрдбрд╝реЗрдВред', threadID);
      } else if (command === 'join') {
        if (this.gameState !== 'waiting') {
          api.sendMessage('рдЧреЗрдо рд╢реБрд░реВ рдирд╣реАрдВ рд╣реБрдЖ рдпрд╛ рдкрд╣рд▓реЗ рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИред #mafia start рдХрд░реЗрдВред', threadID);
          return;
        }
        if (this.players.find(p => p.id === senderID)) {
          api.sendMessage('рддреБрдо рдкрд╣рд▓реЗ рд╕реЗ рдЧреЗрдо рдореЗрдВ рд╣реЛ!', threadID);
          return;
        }
        this.players.push({ id: senderID, name: senderName, role: null, alive: true });
        api.sendMessage(`${senderName} рдЧреЗрдо рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реБрдЖ! рдЕрдм ${this.players.length} рдкреНрд▓реЗрдпрд░ред`, threadID);
      } else if (command === 'begin') {
        if (this.gameState !== 'waiting') {
          api.sendMessage('рдЧреЗрдо рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣рд▓реЗ #mafia start рдХрд░реЗрдВред', threadID);
          return;
        }
        if (this.players.length < 4) {
          api.sendMessage('рдХрдо рд╕реЗ рдХрдо 4 рдкреНрд▓реЗрдпрд░ рдЪрд╛рд╣рд┐рдПред', threadID);
          return;
        }

        this.gameState = 'night';
        this.phase = 1;
        this.nightActions = {};
        this.votes = {};
        this.assignRoles();

        // рд╣рд░ рдкреНрд▓реЗрдпрд░ рдХреЛ рдпреВрдирд┐рдХ рд▓рд┐рдВрдХ рднреЗрдЬреЗрдВ
        this.players.forEach(player => {
          const token = crypto.randomBytes(16).toString('hex');
          roleTokens[token] = { uid: player.id, role: player.role, threadID };
          const link = `https://your-bot-domain.com/role?token=${token}&uid=${player.id}`;
          api.sendMessage(`${player.name}, рддреБрдореНрд╣рд╛рд░рд╛ рд░реЛрд▓ рдЪреЗрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕ рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ: ${link}`, threadID);
        });

        api.sendMessage('ЁЯМЩ рдирд╛рдЗрдЯ 1 рд╢реБрд░реВ! рдЕрдкрдиреЗ рд░реЛрд▓ рдФрд░ рдПрдХреНрд╢рдиреНрд╕ рдХреЗ рд▓рд┐рдП рд▓рд┐рдВрдХ рдЪреЗрдХ рдХрд░реЗрдВред', threadID);
      } else if (command === 'vote' && this.gameState === 'day') {
        const voteIndex = parseInt(args[1]) - 1;
        if (isNaN(voteIndex) || voteIndex < 0 || voteIndex >= this.players.length) {
          api.sendMessage('рдЧрд▓рдд рд╡реЛрдЯ рдирдВрдмрд░ред рд╕рд╣реА рдирдВрдмрд░ рдЪреБрдиреЗрдВред', threadID);
          return;
        }
        const target = this.players[voteIndex];
        if (!target.alive) {
          api.sendMessage('рдпреЗ рдкреНрд▓реЗрдпрд░ рдорд░ рдЪреБрдХрд╛ рд╣реИред', threadID);
          return;
        }
        this.votes[senderID] = target.id;
        api.sendMessage(`${senderName} рдиреЗ ${target.name} рдХреЛ рд╡реЛрдЯ рдХрд┐рдпрд╛ред`, threadID);
        this.checkVotes(api, threadID);
      } else if (command === 'endvote' && this.gameState === 'day') {
        this.endVoting(api, threadID);
      } else if (command === 'stop') {
        this.resetGame();
        api.sendMessage('рдЧреЗрдо рдмрдВрдж рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ред #mafia start рд╕реЗ рдлрд┐рд░ рд╢реБрд░реВ рдХрд░реЗрдВред', threadID);
      }
    }
  },

  assignRoles() {
    const totalPlayers = this.players.length;
    const mafiaCount = Math.floor(totalPlayers / 4);
    const villagers = totalPlayers - mafiaCount - 2; // 1 Doctor, 1 Detective
    const rolePool = [...Array(mafiaCount).fill('Mafia'), 'Doctor', 'Detective', ...Array(villagers).fill('Villager')];

    // рд╢реИрд▓реЗрдВрджреНрд░ рдХреЛ рд╕реНрдкреЗрд╢рд▓ рд░реЛрд▓ (рдбреЙрдХреНрдЯрд░ рдпрд╛ рдбрд┐рдЯреЗрдХреНрдЯрд┐рд╡)
    const shalender = this.players.find(p => p.id === this.masterid);
    if (shalender) {
      const specialRoles = ['Doctor', 'Detective'];
      shalender.role = specialRoles[Math.floor(Math.random() * specialRoles.length)];
      const index = rolePool.indexOf(shalender.role);
      rolePool.splice(index, 1);
    }

    // рдмрд╛рдХреА рдкреНрд▓реЗрдпрд░реНрд╕ рдХреЛ рд░реИрдВрдбрдо рд░реЛрд▓реНрд╕
    this.players.forEach(player => {
      if (player.id !== this.masterid && !player.role) {
        const randomIndex = Math.floor(Math.random() * rolePool.length);
        player.role = rolePool.splice(randomIndex, 1)[0];
      }
    });
  },

  checkVotes(api, threadID) {
    const voteCounts = {};
    this.players.forEach(p => {
      if (p.alive) voteCounts[p.id] = 0;
    });
    Object.values(this.votes).forEach(vote => {
      if (this.players.find(p => p.id === vote && p.alive)) voteCounts[vote]++;
    });

    const maxVotes = Math.max(...Object.values(voteCounts));
    const toEliminate = Object.keys(voteCounts).find(id => voteCounts[id] === maxVotes && maxVotes > this.players.filter(p => p.alive).length / 2);

    if (toEliminate) {
      const eliminated = this.players.find(p => p.id === toEliminate);
      eliminated.alive = false;
      api.sendMessage(`${eliminated.name} рдХреЛ рд╡реЛрдЯрд┐рдВрдЧ рд╕реЗ рдмрд╛рд╣рд░ рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ред`, threadID);
      this.checkGameOver(api, threadID);
    }
  },

  endVoting(api, threadID) {
    this.gameState = 'night';
    this.phase++;
    this.nightActions = {};
    this.votes = {};

    // рдирд╛рдЗрдЯ рдлреЗрдЬ рдХреЗ рд▓рд┐рдП рдирдП рд▓рд┐рдВрдХреНрд╕ рднреЗрдЬреЗрдВ
    this.players.forEach(player => {
      if (player.alive && ['Mafia', 'Doctor', 'Detective'].includes(player.role)) {
        const token = crypto.randomBytes(16).toString('hex');
        roleTokens[token] = { uid: player.id, role: player.role, threadID };
        const link = `https://your-bot-domain.com/role?token=${token}&uid=${player.id}`;
        api.sendMessage(`${player.name}, рдирд╛рдЗрдЯ ${this.phase} рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рдПрдХреНрд╢рдиреНрд╕ рдХреЗ рд▓рд┐рдП рдЗрд╕ рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ: ${link}`, threadID);
      }
    });

    api.sendMessage(`ЁЯМЩ рдирд╛рдЗрдЯ ${this.phase} рд╢реБрд░реВ! рдЕрдкрдиреЗ рдПрдХреНрд╢рдиреНрд╕ рдХреЗ рд▓рд┐рдП рд▓рд┐рдВрдХ рдЪреЗрдХ рдХрд░реЗрдВред`, threadID);

    // рдСрдЯреЛрдореИрдЯрд┐рдХ рдирд╛рдЗрдЯ рдЯрд╛рдЗрдордЖрдЙрдЯ (30 рд╕реЗрдХрдВрдб)
    setTimeout(() => {
      if (this.gameState === 'night') {
        this.checkNightActions(api, threadID);
      }
    }, 30000);
  },

  checkNightActions(api, threadID) {
    let message = `ЁЯМЩ рдирд╛рдЗрдЯ ${this.phase} рд░рд┐рдЬрд▓реНрдЯ:\n`;
    const mafiaTarget = this.nightActions.mafia;
    const doctorTarget = this.nightActions.doctor;

    if (mafiaTarget && mafiaTarget !== doctorTarget) {
      const target = this.players.find(p => p.id === mafiaTarget);
      if (target) {
        target.alive = false;
        message += `${target.name} рдХреЛ рдорд╛рдлрд┐рдпрд╛ рдиреЗ рдорд╛рд░ рджрд┐рдпрд╛ред\n`;
      }
    } else {
      message += 'рдХреЛрдИ рдХрд┐рд▓ рдирд╣реАрдВ рд╣реБрдИред рд╕рдм рд╕реЗрдл!\n';
    }

    api.sendMessage(message, threadID);
    this.checkGameOver(api, threadID);

    if (this.gameState) {
      this.gameState = 'day';
      this.votes = {};
      let voteMessage = `тШАя╕П рдбреЗ ${this.phase} рд╢реБрд░реВ!\nрд╡реЛрдЯрд┐рдВрдЧ рд╢реБрд░реВ рдХрд░реЗрдВ (#mafia vote <number>):\n`;
      this.players.forEach((p, i) => {
        if (p.alive) voteMessage += `${i + 1}. ${p.name}\n`;
      });
      api.sendMessage(voteMessage, threadID);

      // рдСрдЯреЛрдореИрдЯрд┐рдХ рдбреЗ рдЯрд╛рдЗрдордЖрдЙрдЯ (30 рд╕реЗрдХрдВрдб)
      setTimeout(() => {
        if (this.gameState === 'day') {
          this.endVoting(api, threadID);
        }
      }, 30000);
    }
  },

  checkGameOver(api, threadID) {
    const aliveMafia = this.players.filter(p => p.alive && p.role === 'Mafia').length;
    const aliveVillagers = this.players.filter(p => p.alive && p.role !== 'Mafia').length;

    if (aliveMafia === 0) {
      let message = 'ЁЯОо рдЧреЗрдо рдУрд╡рд░: рд╡рд┐рд▓реЗрдЬрд░ рдЬреАрддреЗ! рд╕рд╛рд░реЗ рдорд╛рдлрд┐рдпрд╛ рдорд░ рдЧрдПред\nЁЯУЬ рдЧреЗрдо рд▓реЙрдЧ:\n';
      message += `ЁЯПЖ рдорд╛рдлрд┐рдпрд╛ рдХрд┐рд▓реНрд╕: 0\nЁЯПЖ рд▓реАрдбрд░рдмреЛрд░реНрдб:\n`;
      const shalender = this.players.find(p => p.id === this.masterid);
      if (shalender) {
        message += `@${shalender.name} ЁЯПЕ First, Score: 14/14\n`;
      }
      this.players.forEach((p, i) => {
        if (p.id !== this.masterid) {
          message += `${i + 1}. ${p.name} - ${p.role} (${p.alive ? 'Alive' : 'Dead'})\n`;
        }
      });
      api.sendMessage(message, threadID);
      this.resetGame();
    } else if (aliveMafia >= aliveVillagers) {
      let message = 'ЁЯОо рдЧреЗрдо рдУрд╡рд░: рдорд╛рдлрд┐рдпрд╛ рдЬреАрддреЗ! рд╡рд┐рд▓реЗрдЬрд░реНрд╕ рд╣рд╛рд░ рдЧрдПред\nЁЯУЬ рдЧреЗрдо рд▓реЙрдЧ:\n';
      message += `ЁЯПЖ рдорд╛рдлрд┐рдпрд╛ рдХрд┐рд▓реНрд╕: ${this.players.length - aliveVillagers}\nЁЯПЖ рд▓реАрдбрд░рдмреЛрд░реНрдб:\n`;
      const shalender = this.players.find(p => p.id === this.masterid);
      if (shalender) {
        message += `@${shalender.name} ЁЯПЕ First, Score: 14/14\n`;
      }
      this.players.forEach((p, i) => {
        if (p.id !== this.masterid) {
          message += `${i + 1}. ${p.name} - ${p.role} (${p.alive ? 'Alive' : 'Dead'})\n`;
        }
      });
      api.sendMessage(message, threadID);
      this.resetGame();
    }
  },

  resetGame() {
    this.players = [];
    this.gameState = null;
    this.phase = null;
    this.nightActions = {};
    this.votes = {};
    this.lastVoteTime = null;
    this.commandCooldowns = {};
  },
};
